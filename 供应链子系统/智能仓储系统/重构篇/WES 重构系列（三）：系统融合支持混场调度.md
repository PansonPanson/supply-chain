*文内时序图与重构前后对比图需要科学上网才能流畅查看，图床直接用了 GitHub。*

  

![](https://images.unsplash.com/photo-1762621362503-c771d36f0d40?q=80&w=2776&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D)

  

## 一、为什么要做货架到人与料箱到人两套系统的融合？

随着国内和海外仓业务的发展，部分智能仓要求支持货架到人与料箱到人混场调度，我们旧有的 WES 系统是各自独立的，货架到人 WES 只支持货架仓，料箱到人 WES 只支持料箱仓。

出于支持混场调度，我们做了这次融合。

  

## 二、系统融合的规划与难点

融合涉及的服务主要是工作站 Station 和 WES。

  

工作站服务是独立的两套工作流，但业务逻辑有许多共性。比如拣选业务，都要经过实操亮灯、扫码拣选、拍槽位灯、封箱、全部分播完成等步骤，工作流本身支持按业务类型弹实操，这一块相对来说难点不大，主要还是细活，做代码迁移和表迁移，但话说回来，一些细活其实就是工程能力。

  

WES 这边涉及到的内容多一些：

1. 商品库存：二级库存、三级库存、批次、商品、条码、货主、包装、库存流水、库存调整单、库存快照……

2. 理货业务：分为货架到人理货和料箱到人理货，理货单、理货单明细、理货下架作业单、理货下架作业单明细、理货下架任务……

3. 盘点：也是多种业务，业务对应的表也很多

4. 出库：也是多种业务，业务对应的表也很多

5. 上架：离线和在线都有许多业务模式，对应的表也有许多

  

如果只是实现混场业务调度的目的，粗糙地做也能做，但还是想做一些优化，思考几个问题：

1. 货架到人与料箱到人业务有许多相似点，数据模型（业务表）上有哪些是可以共用的？

2. 也有一些不同点，数据模型（业务表）上哪些最好是隔离的？

3. 代码层面是否可以使用设计模式抽象一些公有逻辑，减少代码复杂度？

4. 合并后，如果海外仓还想继续用单一模式，怎么办？

  

## 三、如何取舍数据模型的共用与隔离？

两套系统主要还是调度实体不同，我们采用了分层设计原则：上层共用、下层隔离。


在上层的单据层、库存商品层，比如出库单、出库单明细、出库作业单、二级库存，其实都是一致的，两套系统可以共用。

下层的调度任务两者不同，所以我们上层的数据模型不变，下层的调度任务，比如出库任务、理货任务、盘点任务、上架任务都做了分离。

分层图如下：

![](file-20251120003840562.png)

