
## 一、WES 与第三方系统数据不一致困境
首先说一下智能仓储系统的场景：智能仓储系统的核心链路涉及多个系统，但是对于数据最终一致性有要求，且部分场景需要提供补偿机制。

我们需要与诸多二方系统和三方系统对接，比如：
1、车辆调度系统，可能就会遇到：
  + 车不来：下发调度信息的时候，消息发送失败，导致车辆不来
  + 来错车：下发调度信息的时候，消息乱序，导致来错车
  + 车不走：下发车辆离站消息的时候，消息发送失败，导致车辆不走
  
2、与算法服务对接
  + 离线任务下发失败
  + 调用算法计算热度
  
3、与外设系统交互，可能会遇到：
  + 灯不亮：
    + 发送亮灯消息的时候，消息发送失败，导致外设系统未接收到消息，灯不亮
    + 外设系统与物理设备交互，调用相关接口失败
  + 灯不灭：
    + 发送灭灯消息的时候，消息发送失败，导致外设系统未接收到消息，灯不灭
    + 外设系统与物理设备交互，调用相关接口失败，灯不灭

  + 亮错灯：
    + 发送亮灯消息的时候，消息乱序，导致外设系统亮灯错乱
    
3、与打印系统交互，可能会遇到：
  + 没打印：接口调用失败，导致单据打印失败

4、与上游系统交互：
  + 各种单据的实操结果未正常反馈上游
    + 出库单按单反馈
    + 出库单按箱反馈
    + 入库单按单反馈
    + 入库单按箱反馈
    + 盘点单按单反馈
    + 库存调整单按单反馈
    + ……
5、与基础数据系统交互
  + 货架热度计算结果更新失败
  + 料箱热度计算结果更新失败
  + 容器位置更新

这些场景无法使用本地事务实现，因为是分布式系统。有些场景也不能纯用 MQ 的消息事务实现，因为 RocketMQ 事务消息重试机制不灵活。

## 二、关于重试逻辑的思考

一个健壮的系统是需要考虑关键节点的稳定性的，以与外部系统交互这种节点来讨论，我觉得核心的意识是不相信第三方系统，无论是数据的获取还是推送。

所以需要实现重试逻辑。

但二方系统、三方系统有许多，如果在每一个节点都去写重试逻辑，那么重试逻辑就会变得不可复用。比如说：
+ 重试次数怎么设置？
+ 每次重试的间隔如何考虑？
+ 重试逻辑是否影响主线程，需要异步化吗？
+ 是否考虑加降级呢？
+ 能不能加告警？
+ ……

## 三、抽象、复用与便捷

考虑以上问题后，我在阅读了转转和得物的关于重试组件的技术博客后，开始有了新的思考。是不是可以抽取出业务需求，自定义一个 springboot starter，用户只需要引入这个 maven 包，做一些简单的配置和适配，就可以做到关键节点的自动重试呢？

很幸运，我在网上找了一些类似的教程和代码，结合得物、转转的技术博客，实现了这个组件。

我们可以基于SpringAOP来实现，将需要重试的逻辑抽取成 public 修饰的方法，在这个方法上加上一致性注解。
拦截所有加了一致性注解的方法，封装为一个重试任务，持久化到数据库中，再通过反射去执行这个任务。


## 四、如何设计自定义注解



![](https://github.com/PansonPanson/Argo/blob/main/doc/image/%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1.png?raw=true)







